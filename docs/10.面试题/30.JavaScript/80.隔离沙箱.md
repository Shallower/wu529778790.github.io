---
title: 隔离沙箱
date: 2022-05-31 17:51:00
permalink: /pages/9b62927443694/
categories:
  - 面试题
  - JavaScript
tags:
  -
---

![73a061edff0b4f17aabed63d6664ec4d](https://gcore.jsdelivr.net/gh/wu529778790/image/blog/73a061edff0b4f17aabed63d6664ec4d.png)

在微前端领域当中，沙箱是很重要的一件事情。像微前端框架 single-spa 没有实现 js 沙箱，我们在构建大型微前端应用的时候，很容易造成一些变量的冲突，对应用的可靠性面临巨大的风险。在微前端当中，有一些全局对象在所有的应用中需要共享，如 document,location,等对象。子应用开发的过程中可能是多个团队在做，很难约束他们使用全局变量。有些页面可能会有多个不同的子应用，需要我们支持多沙箱，每个沙箱需要有加载，卸载，在恢复的能力。

<!-- more -->

## iframe 实现沙箱

```js
let iframe = document.createElement("iframe", { src: "about:blank" });
document.body.appendChild(iframe);
const sandboxGlobal = iframe.contentWindow;
```

> 注意：只有同域的 ifame 才能取出对应的 contentWindow, iframe 的 src 设置为 about:blank,可以保证一定是同域的，也不会发生资源加载，参考 [iframe src](https://developer.mozilla.org/zh-CN/docs/Web/HTML/Element/iframe#attr-src)

微前端除了有一个隔离的 window 环境外，其实还需要共享一些全局对象,这时候我们可以用代理去实现

```js
class SandboxWindow {
  /**
   * 构造函数
   * @param {*} context 需要共享的对象
   * @param {*} frameWindow iframe的window
   */
  constructor(context, frameWindow) {
    return new Proxy(frameWindow, {
      get(target, name) {
        if (name in context) {
          // 优先使用共享对象
          return context[name];
        }
        return target[name];
      },
      set(target, name, value) {
        if (name in context) {
          // 修改共享对象的值
          return (context[name] = value);
        }
        target[name] = value;
      },
    });
  }
}

// 需要全局共享的变量
const context = { document: window.document, history: window.history };

// 创建沙箱
const newSandboxWindow = new SandboxWindow(context, sandboxGlobal);

// 判断沙箱上的对象和全局对象是否相等
console.log("equal", newSandboxWindow.document === window.document);

newSandboxWindow.abc = "1"; //在沙箱上添加属性
console.log(window.abc); // 在全局上查看属性
console.log(newSandboxWindow.abc); //在沙箱上查看属性
```

以上我们利用 iframe 沙箱可以实现以下特性：

- 全局变量隔离，如 setTimeout、location、react 不同版本隔离
- 路由隔离，应用可以实现独立路由，也可以共享全局路由
- 多实例，可以同时存在多个独立的微应用同时运行

## 参考链接

- [说说 JS 中的沙箱](https://juejin.cn/post/6844903954074058760)
- [说说微前端 JS 沙箱实现的几种方式](https://juejin.cn/post/6981374562877308936)
- [乾坤的 Js 隔离机制原理剖析（快照沙箱、两种代理沙箱）](https://juejin.cn/post/7070032850237521956)
